#!/bin/bash

## Location of the different folders
EMUFOLDER="/mnt/store/Emulation"
RSBASEFOLDER="${EMUFOLDER}/Assets/RomScan"
AMIGAFOLDER="${EMUFOLDER}/Games/Commodore - Amiga"
LIVESTORE="${RSBASEFOLDER}/whdLoaded"

## Only one argument accepted which should be the name of the game (with file extension)
GAMEFILE=$(basename "$1")

if ! [ -f "${AMIGAFOLDER}/${GAMEFILE}" ]; then
	echo "Missing valid game archive name."
	exit 1
fi

## Convert the game name to lowercase and remove spaces
SAFENAME=$(basename "${GAMEFILE}" .7z | tr '[A-Z]' '[a-z]' | sed 's/ //g')

## Check if the directory already exists, if it does then we don't really need to do anything
if ! [ -d "${LIVESTORE}/${SAFENAME}" ]; then
	## Create the virtual hard-disk folder using the skeleton
	mkdir -p "${LIVESTORE}"
	cp -r "${RSBASEFOLDER}/WHDLoad-Blank" "${LIVESTORE}/${SAFENAME}"

	## Extract the WHDLoad files
	cd "${LIVESTORE}/${SAFENAME}"
	mkdir Game
	cd Game
	7z x -y "${AMIGAFOLDER}/${GAMEFILE}"

	## Find the slave file
	WHDSLAVE=$(find * -maxdepth 1 -iname "*.slave" | head -n1)

	## Game specific slave options
	if [ "${WHDSLAVE}" == 'Flashback.Slave' ]; then
		EXTRAOPS="CUSTOM4=1"
	fi

	## Add the slave to the startup sequence
	echo -e "\nWHDLoad ${WHDSLAVE} Preload ${EXTRAOPS}\nuae-configuration SPC_QUIT 1" >> ../S/Startup-Sequence
fi

cd ~
fs-uae --kickstart_file=/home/arcade/Documents/FS-UAE/Kickstarts/A1200.rom --hard_drive_0="${LIVESTORE}/${SAFENAME}" --hard_drive_0_priority=6 --hard_drive_1=/mnt/store/Emulation/Assets/RomScan/WHDLoad-Saves
