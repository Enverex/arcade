#!/bin/bash -e

## Sync the main scripts
rsync -arv --no-owner --no-group -e 'ssh -p 222' root@10.2:/mnt/store/Emulation/Arcade-GIT /opt/

## Remove Old Configs
rm -rf /home/arcade/.config/retroarch/playlists 2>/dev/null
rm -rf /home/arcade/.attract/emulators 2>/dev/null
rm -rf /home/arcade/.attract/romlists 2>/dev/null

rm -rf /home/arcade/.emulationstation/es_systems.cfg 2>/dev/null
rm -rf /home/arcade/.emulationstation/gamelists 2>/dev/null

## Open Multiplexed SSH connection
ssh -Nf 10.2 -p222

## Copy New Configs
rsync -rv --no-perms --no-owner --no-group --force -e 'ssh -p 222' root@10.2:/mnt/store/Files/RomScan/generated/AM/{attract.cfg,emulators,romlists} /home/arcade/.attract/
rsync -rv --no-perms --no-owner --no-group --force -e 'ssh -p 222' root@10.2:/mnt/store/Files/RomScan/generated/ES/.emulationstation /home/arcade/

## Sync the Emulation Folders to the server
rsync -zav --no-perms --no-owner --no-group --delete --force -e 'ssh -p 222' root@10.2:/mnt/store/Emulation/{Games,Assets} /mnt/store/Emulation/ --exclude='/mnt/store/Emulation/BrokenWineGames'

## Close SSH multiplex master
ssh -O exit 10.2 -p222

## Fix Permissions
echo "==== Fixing ownership."
chown arcade:arcade -Rc /home/arcade/.attract
chown arcade:arcade -Rc /home/arcade/.emulationstation
chown arcade:arcade -Rc /mnt/store/Emulation

echo "==== Fixing permissions."
find /mnt/store/Emulation -type d -exec chmod -c 755 "{}" \;
find /mnt/store/Emulation -type f -exec chmod -c 644 "{}" \;

echo "==== Fixing executables."
find /mnt/store/Emulation -type f -name "*.sh" -exec chmod -c +x "{}" \;

echo "==== Done"
