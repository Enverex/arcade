#!/bin/bash -e

## Remove Old Configs
rm -rf /home/arcade/.config/retroarch/playlists 2>/dev/null
rm -rf /home/arcade/.attract/emulators 2>/dev/null
rm -rf /home/arcade/.attract/romlists 2>/dev/null

rm -rf /home/arcade/.emulationstation/es_systems.cfg 2>/dev/null
rm -rf /home/arcade/.emulationstation/gamelists 2>/dev/null

## Open Multiplexed SSH connection
ssh -Nf 10.2 -p222

## Copy New Configs
echo "==== Syncing Configs"
rsync -rv --no-perms --no-owner --no-group --force -e 'ssh -p 222' root@10.2:/mnt/store/Files/RomScan/generated/AM/{attract.cfg,emulators,romlists} /home/arcade/.attract/
rsync -rv --no-perms --no-owner --no-group --force -e 'ssh -p 222' root@10.2:/mnt/store/Files/RomScan/generated/ES/.emulationstation /home/arcade/

## Sync the Emulation Media Assets
echo "==== Syncing Assets"
rsync -Lav --no-perms --no-owner --no-group --delete --force -e 'ssh -p 222' root@10.2:/mnt/store/Emulation/Assets/Live /mnt/store/Emulation/Assets/
rsync -zav --no-perms --no-owner --no-group --delete --force -e 'ssh -p 222' root@10.2:/mnt/store/Emulation/Misc /mnt/store/Emulation/

## Sync Game Content
echo "==== Syncing Games"
rsync -zav --no-perms --no-owner --no-group --delete --force -e 'ssh -p 222' root@10.2:/mnt/store/Emulation/Games /mnt/store/Emulation/

## Close SSH multiplex master
ssh -O exit 10.2 -p222

## Fix Permissions
echo "==== Fixing ownership."
chown arcade:arcade -R /home/arcade/.attract
chown arcade:arcade -R /home/arcade/.emulationstation
chown arcade:arcade -R /mnt/store/Emulation

echo "==== Fixing permissions."
find /mnt/store/Emulation -type d -exec chmod -c 755 "{}" \;
find /mnt/store/Emulation -type f ! -name "*.sh" -exec chmod -c 644 "{}" \;

echo "==== Fixing executables."
find /mnt/store/Emulation/Games -type f -name "*.sh" -exec chmod -c +x "{}" \;

echo "==== Done"
